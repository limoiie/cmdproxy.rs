# This docker-compose.yml file is used for the tests.
# It deploys an empty mongodb and a redis.

version: '3'
services:
  db:
    image: mongo:latest
    container_name: cmdproxy-db
    networks:
      - overlay
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_DATABASE=testdb

  broker:
    image: redis:latest
    container_name: cmdproxy-broker
    networks:
      - overlay
    ports:
      - "6379:6379"
    
  cmdproxy:
    build: .
    image: cmdproxy:0.2.2
    container_name: cmdproxy-server
    depends_on:
      - db
      - broker
    networks:
      - overlay
    environment:
      - CMDPROXY_MONGODB_NAME=testdb
      - CMDPROXY_MONGO_URL=mongodb://db:27017
      - CMDPROXY_REDIS_URL=redis://broker:6379

  py-client:
    build:
      context: .
      dockerfile: ./examples/Dockerfile.client-py
    image: cmdproxy-example-client-py:0.2.2
    container_name: cmdproxy-client
    depends_on:
      - db
      - broker
    networks:
      - overlay
    environment:
      - CMDPROXY_MONGODB_NAME=testdb
      - CMDPROXY_MONGO_URL=mongodb://db:27017
      - CMDPROXY_REDIS_URL=redis://broker:6379
    profiles: ["py-client"]

  rs-client:
    build:
      context: .
      dockerfile: ./examples/Dockerfile.client-rs
    image: cmdproxy-example-client-py:0.2.2
    container_name: cmdproxy-client
    depends_on:
      - db
      - broker
    networks:
      - overlay
    environment:
      - CMDPROXY_MONGODB_NAME=testdb
      - CMDPROXY_MONGO_URL=mongodb://db:27017
      - CMDPROXY_REDIS_URL=redis://broker:6379
    profiles: ["rs-client"]

networks:
  overlay:

